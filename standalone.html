<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„ÉÅ„É£„ÉÉ„Éà</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #f0f0f0;
        }
        
        .name-input-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .name-input-modal {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            min-width: 300px;
        }
        
        .name-input-modal h2 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .name-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            margin-bottom: 20px;
        }
        
        .name-submit-button {
            padding: 10px 30px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        
        .name-submit-button:hover {
            background-color: #0056b3;
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            display: none;
        }
        
        .chat-header {
            background-color: #007bff;
            color: white;
            padding: 15px;
            text-align: center;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #fafafa;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 10px;
            max-width: 70%;
            word-wrap: break-word;
            position: relative;
        }
        
        .message:hover .message-actions {
            display: block;
        }
        
        .message-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            display: none;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 5px;
            padding: 2px;
        }
        
        .delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 12px;
            padding: 2px 5px;
            color: #dc3545;
        }
        
        .delete-btn:hover {
            background-color: #dc3545;
            color: white;
            border-radius: 3px;
        }
        
        .message-sender {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 5px;
            opacity: 0.7;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #007bff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .message-time {
            font-size: 10px;
            opacity: 0.5;
            margin-top: 5px;
        }
        
        .read-status {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 2px;
            color: #007bff;
        }
        
        .unread-indicator {
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .notification-permission {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: #007bff;
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 1001;
            display: none;
        }
        
        .notification-button {
            margin-left: 10px;
            padding: 5px 10px;
            background-color: #fff;
            color: #007bff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .message.sent {
            background-color: #007bff;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        
        .message.received {
            background-color: #e9ecef;
            color: #333;
        }
        
        .chat-input-container {
            display: flex;
            padding: 15px;
            background-color: white;
            border-top: 1px solid #e0e0e0;
        }
        
        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            outline: none;
            font-size: 16px;
        }
        
        .send-button {
            margin-left: 10px;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .send-button:hover {
            background-color: #0056b3;
        }
        
        .media-message {
            margin: 10px 0;
        }
        
        .media-message img {
            max-width: 300px;
            max-height: 200px;
            border-radius: 10px;
        }
        
        .file-link {
            color: #007bff;
            text-decoration: none;
            padding: 5px 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            display: inline-block;
        }
        
        .media-buttons {
            display: flex;
            gap: 5px;
            margin-right: 10px;
        }
        
        .media-button {
            padding: 8px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .media-button:hover {
            background-color: #5a6268;
        }
        
        .file-input {
            display: none;
        }
        
        .header-button {
            padding: 5px 10px;
            margin: 0 5px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .header-button:hover {
            background-color: #218838;
        }
        
        .fix-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: #dc3545;
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 1001;
            display: none;
        }
        
        .fix-button {
            margin-left: 10px;
            padding: 5px 10px;
            background-color: #fff;
            color: #dc3545;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .emoji-panel {
            position: absolute;
            bottom: 60px;
            left: 50px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
            max-width: 300px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .emoji-category {
            margin-bottom: 10px;
        }
        
        .emoji-category h4 {
            margin: 0 0 5px 0;
            font-size: 12px;
            color: #666;
        }
        
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 5px;
        }
        
        .emoji-item {
            padding: 8px;
            text-align: center;
            cursor: pointer;
            border-radius: 5px;
            font-size: 20px;
            transition: background-color 0.2s;
        }
        
        .emoji-item:hover {
            background-color: #f0f0f0;
        }
        
        .animated-emoji {
            display: inline-block;
            animation-duration: 1s;
            animation-iteration-count: infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes wave {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(20deg); }
            75% { transform: rotate(-20deg); }
        }
        
        @keyframes flip {
            0% { transform: rotateY(0deg); }
            50% { transform: rotateY(180deg); }
            100% { transform: rotateY(0deg); }
        }
        
        @keyframes rainbow {
            0% { filter: hue-rotate(0deg); }
            25% { filter: hue-rotate(90deg); }
            50% { filter: hue-rotate(180deg); }
            75% { filter: hue-rotate(270deg); }
            100% { filter: hue-rotate(360deg); }
        }
        
        @keyframes swing {
            0%, 100% { transform: rotate(0deg) translateX(0px); }
            25% { transform: rotate(5deg) translateX(5px); }
            75% { transform: rotate(-5deg) translateX(-5px); }
        }
        
        @keyframes zoom {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }
        
        @keyframes wobble {
            0%, 100% { transform: translateX(0px); }
            15% { transform: translateX(-10px) rotate(-5deg); }
            30% { transform: translateX(10px) rotate(3deg); }
            45% { transform: translateX(-5px) rotate(-2deg); }
            60% { transform: translateX(5px) rotate(1deg); }
            75% { transform: translateX(-2px) rotate(-1deg); }
        }
        
        @keyframes glow {
            0%, 100% { text-shadow: 0 0 5px currentColor; }
            50% { text-shadow: 0 0 20px currentColor, 0 0 30px currentColor; }
        }
        
        @keyframes fade {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        @keyframes slide {
            0%, 100% { transform: translateX(0px); }
            50% { transform: translateX(20px); }
        }
        
        @keyframes rotate3d {
            0% { transform: rotateX(0deg) rotateY(0deg); }
            25% { transform: rotateX(90deg) rotateY(0deg); }
            50% { transform: rotateX(90deg) rotateY(90deg); }
            75% { transform: rotateX(0deg) rotateY(90deg); }
            100% { transform: rotateX(0deg) rotateY(0deg); }
        }
        
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.2); }
            50% { transform: scale(1); }
            75% { transform: scale(1.1); }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
        }
        
        @keyframes dance {
            0%, 100% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(-10deg) scale(1.1); }
            50% { transform: rotate(10deg) scale(0.9); }
            75% { transform: rotate(-5deg) scale(1.05); }
        }
        
        @keyframes explode {
            0% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.5) rotate(180deg); }
            100% { transform: scale(1) rotate(360deg); }
        }
        
        @keyframes typing {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-3px); }
        }
        
        .bounce { animation-name: bounce; }
        .shake { animation-name: shake; }
        .spin { animation-name: spin; }
        .pulse { animation-name: pulse; }
        .wave { animation-name: wave; }
        .flip { animation-name: flip; }
        .rainbow { animation-name: rainbow; }
        .swing { animation-name: swing; }
        .zoom { animation-name: zoom; }
        .wobble { animation-name: wobble; }
        .glow { animation-name: glow; }
        .fade { animation-name: fade; }
        .slide { animation-name: slide; }
        .rotate3d { animation-name: rotate3d; }
        .heartbeat { animation-name: heartbeat; }
        .float { animation-name: float; }
        .dance { animation-name: dance; }
        .explode { animation-name: explode; }
        .typing { animation-name: typing; }
        
        .custom-emoji {
            display: inline-block;
            font-size: 20px;
            font-weight: bold;
            padding: 2px;
            border-radius: 50%;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        
        .fire-emoji {
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            color: white;
        }
        
        .ice-emoji {
            background: linear-gradient(45deg, #74b9ff, #0984e3);
            color: white;
        }
        
        .magic-emoji {
            background: linear-gradient(45deg, #a29bfe, #6c5ce7);
            color: white;
        }
        
        .love-emoji {
            background: linear-gradient(45deg, #fd79a8, #e84393);
            color: white;
        }
        
        .electric-emoji {
            background: linear-gradient(45deg, #fdcb6e, #e17055);
            color: white;
        }
        
        .space-emoji {
            background: linear-gradient(45deg, #6c5ce7, #2d3436);
            color: white;
        }
        
        .ocean-emoji {
            background: linear-gradient(45deg, #00cec9, #0984e3);
            color: white;
        }
        
        .forest-emoji {
            background: linear-gradient(45deg, #00b894, #55a3ff);
            color: white;
        }
        
        .sunset-emoji {
            background: linear-gradient(45deg, #fd79a8, #fdcb6e);
            color: white;
        }
        
        .neon-emoji {
            background: linear-gradient(45deg, #00cec9, #55a3ff);
            color: white;
            text-shadow: 0 0 10px currentColor;
        }
        
        .crystal-emoji {
            background: linear-gradient(45deg, #a29bfe, #74b9ff);
            color: white;
        }
        
        .volcano-emoji {
            background: linear-gradient(45deg, #e17055, #2d3436);
            color: white;
        }
        
        .emoji-icon {
            display: inline-block;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            position: relative;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            line-height: 24px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .star-icon {
            background: linear-gradient(45deg, #fdcb6e, #e17055);
            position: relative;
        }
        
        .star-icon::before {
            content: '‚òÖ';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
        }
        
        .heart-icon {
            background: linear-gradient(45deg, #fd79a8, #e84393);
            position: relative;
        }
        
        .heart-icon::before {
            content: '‚ô•';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
        }
        
        .lightning-icon {
            background: linear-gradient(45deg, #fdcb6e, #f39c12);
            position: relative;
        }
        
        .lightning-icon::before {
            content: '‚ö°';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
        }
        
        .diamond-icon {
            background: linear-gradient(45deg, #74b9ff, #0984e3);
            position: relative;
        }
        
        .diamond-icon::before {
            content: '‚óÜ';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
        }
        
        .flower-icon {
            background: linear-gradient(45deg, #fd79a8, #fdcb6e);
            position: relative;
        }
        
        .flower-icon::before {
            content: '‚ùÄ';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
        }
        
        .crown-icon {
            background: linear-gradient(45deg, #fdcb6e, #e17055);
            position: relative;
        }
        
        .crown-icon::before {
            content: '‚ôõ';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
        }
        
        .music-icon {
            background: linear-gradient(45deg, #a29bfe, #6c5ce7);
            position: relative;
        }
        
        .music-icon::before {
            content: '‚ô™';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
        }
        
        .peace-icon {
            background: linear-gradient(45deg, #00b894, #55a3ff);
            position: relative;
        }
        
        .peace-icon::before {
            content: '‚òÆ';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
        }
        
        .sun-icon {
            background: linear-gradient(45deg, #fdcb6e, #f39c12);
            position: relative;
        }
        
        .sun-icon::before {
            content: '‚òÄ';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
        }
        
        .moon-icon {
            background: linear-gradient(45deg, #636e72, #2d3436);
            position: relative;
        }
        
        .moon-icon::before {
            content: '‚òæ';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
        }
        
        .cloud-icon {
            background: linear-gradient(45deg, #74b9ff, #0984e3);
            position: relative;
        }
        
        .cloud-icon::before {
            content: '‚òÅ';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
        }
        
        .snowflake-icon {
            background: linear-gradient(45deg, #74b9ff, #ffffff);
            position: relative;
        }
        
        .snowflake-icon::before {
            content: '‚ùÖ';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
        }
        
        .poll-container {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .poll-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .poll-option {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 8px 12px;
            margin: 5px 0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .poll-option:hover {
            background-color: #e9ecef;
        }
        
        .poll-option.voted {
            background-color: #007bff;
            color: white;
        }
        
        .poll-votes {
            font-size: 12px;
            opacity: 0.7;
        }
        
        .game-container {
            background-color: #e8f5e9;
            border: 2px solid #4caf50;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
        }
        
        .game-title {
            font-weight: bold;
            color: #4caf50;
            margin-bottom: 10px;
        }
        
        .game-button {
            background-color: #4caf50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            margin: 5px;
            cursor: pointer;
        }
        
        .game-button:hover {
            background-color: #45a049;
        }
        
        .location-container {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
        }
        
        .location-link {
            color: #007bff;
            text-decoration: none;
        }
        
        .location-link:hover {
            text-decoration: underline;
        }
        
        .tools-panel {
            position: absolute;
            bottom: 60px;
            left: 50px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
        }
        
        .tool-button {
            display: block;
            width: 100%;
            padding: 8px 16px;
            margin: 5px 0;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            text-align: left;
        }
        
        .tool-button:hover {
            background-color: #e9ecef;
        }
        
        .tool-icon {
            margin-right: 5px;
        }
        
        .timer-container {
            background-color: #ffeaa7;
            border: 2px solid #fdcb6e;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
        }
        
        .timer-display {
            font-size: 24px;
            font-weight: bold;
            color: #2d3436;
            margin: 10px 0;
        }
        
        .timer-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }
        
        .timer-button {
            background-color: #fdcb6e;
            color: #2d3436;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .timer-button:hover {
            background-color: #f39c12;
        }
        
        .custom-quiz-container {
            background-color: #dfe6e9;
            border: 2px solid #74b9ff;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .quiz-question {
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .quiz-answer-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .avatar-selector {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 10px 0;
        }
        
        .avatar-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .avatar-option:hover {
            border-color: #007bff;
        }
        
        .avatar-option.selected {
            border-color: #007bff;
            background-color: #e9ecef;
        }
        
        .custom-emoji-creator {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            margin: 10px;
        }
        
        .custom-emoji-preview {
            width: 50px;
            height: 50px;
            border: 2px dashed #ddd;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px auto;
            font-size: 24px;
            background-color: #f8f9fa;
        }
        
        .emoji-input-group {
            margin: 10px 0;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .emoji-input-group label {
            min-width: 60px;
            font-size: 12px;
        }
        
        .emoji-input-group input, 
        .emoji-input-group select {
            flex: 1;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .create-emoji-btn {
            width: 100%;
            padding: 8px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .create-emoji-btn:hover {
            background-color: #218838;
        }
        
        .user-emoji-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin-top: 10px;
        }
        
        .user-emoji-item {
            position: relative;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            font-size: 16px;
        }
        
        .user-emoji-item:hover {
            background-color: #f0f0f0;
        }
        
        .delete-user-emoji {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 16px;
            height: 16px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 10px;
            cursor: pointer;
            display: none;
        }
        
        .user-emoji-item:hover .delete-user-emoji {
            display: block;
        }
    </style>
</head>
<body>
    <div class="name-input-overlay" id="nameInputOverlay">
        <div class="name-input-modal">
            <h2>„ÅäÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h2>
            <input type="text" class="name-input" id="usernameInput" placeholder="ÂêçÂâç„ÇíÂÖ•Âäõ..." autofocus>
            
            <div class="avatar-selector">
                <h3 style="font-size: 14px; margin-bottom: 10px;">„Ç¢„Éê„Çø„Éº„ÇíÈÅ∏Êäû</h3>
                <div class="avatar-grid" id="avatarGrid">
                    <div class="avatar-option" data-avatar="üòÄ">üòÄ</div>
                    <div class="avatar-option" data-avatar="üòé">üòé</div>
                    <div class="avatar-option" data-avatar="ü§ñ">ü§ñ</div>
                    <div class="avatar-option" data-avatar="üëΩ">üëΩ</div>
                    <div class="avatar-option" data-avatar="ü¶Ñ">ü¶Ñ</div>
                    <div class="avatar-option" data-avatar="üê±">üê±</div>
                    <div class="avatar-option" data-avatar="üê∂">üê∂</div>
                    <div class="avatar-option" data-avatar="üêº">üêº</div>
                    <div class="avatar-option" data-avatar="ü¶Å">ü¶Å</div>
                    <div class="avatar-option" data-avatar="üê∏">üê∏</div>
                </div>
            </div>
            
            <button class="name-submit-button" id="nameSubmitButton">„ÉÅ„É£„ÉÉ„Éà„ÇíÈñãÂßã</button>
        </div>
    </div>
    
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <h1>„ÉÅ„É£„ÉÉ„Éà<span id="unreadIndicator" class="unread-indicator" style="display: none;">0</span></h1>
            <div id="currentUser" style="font-size: 14px; margin-top: 5px;"></div>
            <div style="margin-top: 10px;">
                <button class="header-button" onclick="changeName()">ÂêçÂâçÂ§âÊõ¥</button>
                <button class="header-button" onclick="reloadMessages()">ÂÜçË™≠Ëæº</button>
                <button class="header-button" onclick="clearChat()">„ÇØ„É™„Ç¢</button>
            </div>
        </div>
        <div class="chat-messages" id="chatMessages">
        </div>
        <div class="chat-input-container">
            <div class="media-buttons">
                <button class="media-button" id="fileButton" title="„Éï„Ç°„Ç§„É´">üìÅ</button>
                <button class="media-button" id="emojiButton" title="ÁµµÊñáÂ≠ó">üòä</button>
                <button class="media-button" id="toolsButton" title="„ÉÑ„Éº„É´">üîß</button>
            </div>
            <div class="tools-panel" id="toolsPanel">
                <button class="tool-button" onclick="createPoll()">
                    <span class="tool-icon">üìä</span>„Ç¢„É≥„Ç±„Éº„Éà‰ΩúÊàê
                </button>
                <button class="tool-button" onclick="startQuiz()">
                    <span class="tool-icon">‚ùì</span>„ÇØ„Ç§„Ç∫„ÇíÂßã„ÇÅ„Çã
                </button>
                <button class="tool-button" onclick="startShiritori()">
                    <span class="tool-icon">üî§</span>„Åó„Çä„Å®„Çä„ÇíÂßã„ÇÅ„Çã
                </button>
                <button class="tool-button" onclick="startJanken()">
                    <span class="tool-icon">‚úä</span>„Åò„ÇÉ„Çì„Åë„Çì„Çí„Åô„Çã
                </button>
                <button class="tool-button" onclick="shareLocation()">
                    <span class="tool-icon">üìç</span>ÁèæÂú®‰ΩçÁΩÆ„ÇíÂÖ±Êúâ
                </button>
                <button class="tool-button" onclick="startTimer()">
                    <span class="tool-icon">‚è∞</span>„Çø„Ç§„Éû„ÉºË®≠ÂÆö
                </button>
                <button class="tool-button" onclick="createCustomQuiz()">
                    <span class="tool-icon">üìù</span>„ÇØ„Ç§„Ç∫„Çí‰ΩúÊàê
                </button>
            </div>
            <div class="emoji-panel" id="emojiPanel">
                <div class="emoji-category">
                    <h4>Âü∫Êú¨ÁöÑ„Å™ÁµµÊñáÂ≠ó</h4>
                    <div class="emoji-grid" id="basicEmojis"></div>
                </div>
                <div class="emoji-category">
                    <h4>Âãï„ÅèÁµµÊñáÂ≠ó</h4>
                    <div class="emoji-grid" id="animatedEmojis"></div>
                </div>
                <div class="emoji-category">
                    <h4>ÁâπÂà•„Å™ÁµµÊñáÂ≠ó</h4>
                    <div class="emoji-grid" id="specialEmojis"></div>
                </div>
                <div class="emoji-category">
                    <h4>„Ç™„É™„Ç∏„Éä„É´ÁµµÊñáÂ≠ó</h4>
                    <div class="emoji-grid" id="customEmojis"></div>
                </div>
                <div class="emoji-category">
                    <h4>„Ç¢„Ç§„Ç≥„É≥ÁµµÊñáÂ≠ó</h4>
                    <div class="emoji-grid" id="iconEmojis"></div>
                </div>
                <div class="emoji-category">
                    <h4>Ëá™‰ΩúÁµµÊñáÂ≠ó</h4>
                    <div class="custom-emoji-creator">
                        <div class="custom-emoji-preview" id="emojiPreview">?</div>
                        <div class="emoji-input-group">
                            <label>ÊñáÂ≠ó:</label>
                            <input type="text" id="emojiText" placeholder="ÊñáÂ≠ó" maxlength="3">
                        </div>
                        <div class="emoji-input-group">
                            <label>Ëâ≤:</label>
                            <input type="color" id="emojiColor" value="#007bff">
                        </div>
                        <div class="emoji-input-group">
                            <label>ËÉåÊôØ:</label>
                            <input type="color" id="emojiBgColor" value="#ffffff">
                        </div>
                        <div class="emoji-input-group">
                            <label>ÂäπÊûú:</label>
                            <select id="emojiAnimation">
                                <option value="none">„Å™„Åó</option>
                                <option value="bounce">Ë∑≥„Å≠„Çã</option>
                                <option value="spin">ÂõûËª¢</option>
                                <option value="pulse">ËÑàÊâì„Å§</option>
                                <option value="shake">Èúá„Åà„Çã</option>
                                <option value="glow">ÂÖâ„Çã</option>
                            </select>
                        </div>
                        <button class="create-emoji-btn" onclick="createUserEmoji()">ÁµµÊñáÂ≠ó„Çí‰ΩúÊàê</button>
                    </div>
                    <div class="user-emoji-grid" id="userEmojiGrid"></div>
                </div>
            </div>
            <input type="file" class="file-input" id="fileInput" accept="*/*">
            <input type="text" class="chat-input" id="messageInput" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ...">
            <button class="send-button" id="sendButton">ÈÄÅ‰ø°</button>
        </div>
    </div>
    
    <div class="notification-permission" id="notificationPermission">
        üîî ÈÄöÁü•„ÇíÊúâÂäπ„Å´„Åó„Åæ„Åô„ÅãÔºü
        <button class="notification-button" onclick="enableNotifications()">ÊúâÂäπ„Å´„Åô„Çã</button>
        <button class="notification-button" onclick="dismissNotificationPrompt()">Âæå„Åß</button>
    </div>
    
    <script>
        let currentUsername = '';
        let currentAvatar = 'üòÄ';
        let messageHistory = [];
        let unreadCount = 0;
        let isWindowFocused = true;
        let lastReadTime = new Date();
        let currentGame = null;
        let pollData = {};
        let userAvatars = {};
        let activeTimers = {};
        let userEmojis = [];
        
        const nameInputOverlay = document.getElementById('nameInputOverlay');
        const usernameInput = document.getElementById('usernameInput');
        const nameSubmitButton = document.getElementById('nameSubmitButton');
        const chatContainer = document.getElementById('chatContainer');
        const currentUserDisplay = document.getElementById('currentUser');
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const fileButton = document.getElementById('fileButton');
        const fileInput = document.getElementById('fileInput');
        const emojiButton = document.getElementById('emojiButton');
        const emojiPanel = document.getElementById('emojiPanel');
        const unreadIndicator = document.getElementById('unreadIndicator');
        const notificationPermission = document.getElementById('notificationPermission');
        const toolsButton = document.getElementById('toolsButton');
        const toolsPanel = document.getElementById('toolsPanel');
        
        // ÁµµÊñáÂ≠ó„Éá„Éº„Çø
        const basicEmojis = [
            'üòÄ', 'üòÅ', 'üòÇ', 'üòÉ', 'üòÑ', 'üòÖ',
            'üòÜ', 'üòá', 'üòà', 'üòâ', 'üòä', 'üòã',
            'üòå', 'üòç', 'üòé', 'üòè', 'üòê', 'üòë',
            'üòí', 'üòì', 'üòî', 'üòï', 'üòñ', 'üòó',
            'üòò', 'üòô', 'üòö', 'üòõ', 'üòú', 'üòù',
            'üòû', 'üòü', 'üò†', 'üò°', 'üò¢', 'üò£',
            'üò§', 'üò•', 'üò¶', 'üòß', 'üò®', 'üò©',
            'üò™', 'üò´', 'üò¨', 'üò≠', 'üòÆ', 'üòØ',
            'üò∞', 'üò±', 'üò≤', 'üò≥', 'üò¥', 'üòµ'
        ];
        
        const animatedEmojis = [
            { emoji: 'üòÇ', class: 'bounce', name: 'Á¨ë„ÅÑ' },
            { emoji: 'üòç', class: 'pulse', name: '„Éè„Éº„ÉàÁõÆ' },
            { emoji: 'üò°', class: 'shake', name: 'ÊÄí„Çä' },
            { emoji: 'üéâ', class: 'spin', name: '„ÅäÁ•ù„ÅÑ' },
            { emoji: 'üëã', class: 'wave', name: 'Êâã„ÇíÊåØ„Çã' },
            { emoji: '‚ù§Ô∏è', class: 'heartbeat', name: '„Éè„Éº„Éà' },
            { emoji: 'üéÜ', class: 'explode', name: 'Ëä±ÁÅ´' },
            { emoji: 'üåà', class: 'rainbow', name: 'Ëôπ' },
            { emoji: '‚≠ê', class: 'glow', name: 'Êòü' },
            { emoji: 'üí´', class: 'wobble', name: '„ÇÅ„Åæ„ÅÑ' },
            { emoji: 'üò±', class: 'shake', name: '„Éì„ÉÉ„ÇØ„É™' },
            { emoji: 'üò≠', class: 'bounce', name: 'Ê≥£„Åè' },
            { emoji: 'üéÉ', class: 'swing', name: '„Éè„É≠„Ç¶„Ç£„É≥' },
            { emoji: 'üéÑ', class: 'flip', name: '„ÇØ„É™„Çπ„Éû„Çπ' },
            { emoji: 'üéà', class: 'float', name: 'È¢®Ëàπ' },
            { emoji: 'üî•', class: 'dance', name: 'ÁÅ´' },
            { emoji: '‚ö°', class: 'glow', name: 'Èõ∑' },
            { emoji: 'üåä', class: 'wave', name: 'Ê≥¢' },
            { emoji: 'üåô', class: 'fade', name: 'Êúà' },
            { emoji: '‚òÄÔ∏è', class: 'glow', name: 'Â§™ÈôΩ' },
            { emoji: 'üåü', class: 'rotate3d', name: '„Ç≠„É©„Ç≠„É©Êòü' },
            { emoji: 'üíé', class: 'rainbow', name: '„ÉÄ„Ç§„É§' },
            { emoji: 'üëª', class: 'float', name: '„Ç¥„Éº„Çπ„Éà' },
            { emoji: 'üéµ', class: 'slide', name: 'Èü≥Ê•Ω' },
            { emoji: 'üöÄ', class: 'slide', name: '„É≠„Ç±„ÉÉ„Éà' },
            { emoji: 'üåÄ', class: 'spin', name: 'Âè∞È¢®' },
            { emoji: 'üí•', class: 'explode', name: 'ÁàÜÁô∫' },
            { emoji: '‚öΩ', class: 'bounce', name: '„Çµ„ÉÉ„Ç´„Éº' },
            { emoji: 'üéØ', class: 'rotate3d', name: '„ÉÄ„Éº„ÉÑ' },
            { emoji: 'üé≠', class: 'flip', name: 'ÊºîÂäá' }
        ];
        
        const customEmojis = [
            { text: 'FIRE', class: 'fire-emoji dance', name: '„Éï„Ç°„Ç§„Ç¢' },
            { text: 'ICE', class: 'ice-emoji pulse', name: '„Ç¢„Ç§„Çπ' },
            { text: '‚ú®', class: 'magic-emoji rainbow', name: '„Éû„Ç∏„ÉÉ„ÇØ' },
            { text: 'LOVE', class: 'love-emoji heartbeat', name: '„É©„Éñ' },
            { text: 'WOW', class: 'electric-emoji explode', name: '„ÉØ„Ç™' },
            { text: 'YES', class: 'forest-emoji bounce', name: '„Ç§„Ç®„Çπ' },
            { text: 'NO', class: 'volcano-emoji shake', name: '„Éé„Éº' },
            { text: 'OK', class: 'ocean-emoji wave', name: '„Ç™„Éº„Ç±„Éº' },
            { text: 'HI', class: 'sunset-emoji wave', name: '„Éè„Ç§' },
            { text: 'BYE', class: 'space-emoji fade', name: '„Éê„Ç§' },
            { text: 'THX', class: 'crystal-emoji glow', name: '„Çµ„É≥„ÇØ„Çπ' },
            { text: 'OMG', class: 'neon-emoji wobble', name: '„Ç™„Éº„Éû„Ç§„Ç¨„ÉÉ„Éâ' },
            { text: 'BOOM', class: 'volcano-emoji explode', name: '„Éñ„Éº„É†' },
            { text: 'COOL', class: 'ice-emoji slide', name: '„ÇØ„Éº„É´' },
            { text: 'HOT', class: 'fire-emoji glow', name: '„Éõ„ÉÉ„Éà' },
            { text: 'STAR', class: 'neon-emoji rotate3d', name: '„Çπ„Çø„Éº' },
            { text: 'MOON', class: 'space-emoji fade', name: '„É†„Éº„É≥' },
            { text: 'SUN', class: 'sunset-emoji glow', name: '„Çµ„É≥' },
            { text: 'WIND', class: 'crystal-emoji slide', name: '„Ç¶„Ç£„É≥„Éâ' },
            { text: 'WAVE', class: 'ocean-emoji wave', name: '„Ç¶„Çß„Éº„Éñ' },
            { text: 'GLOW', class: 'electric-emoji glow', name: '„Ç∞„É≠„Ç¶' },
            { text: 'FLOW', class: 'forest-emoji float', name: '„Éï„É≠„Ç¶' },
            { text: 'ZOOM', class: 'neon-emoji zoom', name: '„Ç∫„Éº„É†' },
            { text: 'SPIN', class: 'crystal-emoji spin', name: '„Çπ„Éî„É≥' },
            { text: 'FLIP', class: 'magic-emoji flip', name: '„Éï„É™„ÉÉ„Éó' },
            { text: 'BEAT', class: 'electric-emoji heartbeat', name: '„Éì„Éº„Éà' },
            { text: 'VIBE', class: 'sunset-emoji dance', name: '„Éê„Ç§„Éñ' },
            { text: 'NOVA', class: 'space-emoji explode', name: '„Éé„É¥„Ç°' }
        ];
        
        const iconEmojis = [
            { icon: 'star-icon', class: 'emoji-icon star-icon glow', name: '„Çπ„Çø„Éº' },
            { icon: 'heart-icon', class: 'emoji-icon heart-icon heartbeat', name: '„Éè„Éº„Éà' },
            { icon: 'lightning-icon', class: 'emoji-icon lightning-icon shake', name: 'Á®≤Â¶ª' },
            { icon: 'diamond-icon', class: 'emoji-icon diamond-icon rainbow', name: '„ÉÄ„Ç§„É§„É¢„É≥„Éâ' },
            { icon: 'flower-icon', class: 'emoji-icon flower-icon bounce', name: '„Éï„É©„ÉØ„Éº' },
            { icon: 'crown-icon', class: 'emoji-icon crown-icon pulse', name: '„ÇØ„É©„Ç¶„É≥' },
            { icon: 'music-icon', class: 'emoji-icon music-icon wave', name: '„Éü„É•„Éº„Ç∏„ÉÉ„ÇØ' },
            { icon: 'peace-icon', class: 'emoji-icon peace-icon spin', name: '„Éî„Éº„Çπ' },
            { icon: 'sun-icon', class: 'emoji-icon sun-icon glow', name: '„Çµ„É≥' },
            { icon: 'moon-icon', class: 'emoji-icon moon-icon fade', name: '„É†„Éº„É≥' },
            { icon: 'cloud-icon', class: 'emoji-icon cloud-icon float', name: '„ÇØ„É©„Ç¶„Éâ' },
            { icon: 'snowflake-icon', class: 'emoji-icon snowflake-icon spin', name: '„Çπ„Éé„Éº„Éï„É¨„Éº„ÇØ' }
        ];
        
        const specialEmojis = [
            'üéÖ', 'üéÑ', 'üéÅ', 'üéÇ', 'üéÜ', 'üéá',
            'üéà', 'üéâ', 'üéä', 'üéã', 'üéå', 'üéç',
            'üéé', 'üéè', 'üéê', 'üéë', 'üéí', 'üéì',
            'üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'üêª',
            'üêº', 'üê®', 'üêØ', 'ü¶Å', 'üêÆ', 'üê∑',
            'üêΩ', 'üê∏', 'üêô', 'üêµ', 'üôà', 'üôâ',
            'üå∏', 'üå∫', 'üåª', 'üå∑', 'üåπ', 'üåº',
            'üçé', 'üçä', 'üçã', 'üçå', 'üçá', 'üçì',
            '‚öΩ', 'üèÄ', 'üèà', '‚öæ', 'üéæ', 'üèê',
            'üé∏', 'üéπ', 'üé∫', 'üé∑', 'ü•Å', 'üé§',
            'üöó', 'üöï', 'üöô', 'üöå', 'üöé', 'üèéÔ∏è',
            '‚úàÔ∏è', 'üöÅ', 'üö¢', '‚õµ', 'üö§', 'üõ∏'
        ];
        
        // LocalStorage„Åã„Çâ„É°„ÉÉ„Çª„Éº„Ç∏Â±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø
        function loadMessages() {
            const saved = localStorage.getItem('chatMessages');
            const savedPollData = localStorage.getItem('pollData');
            
            if (savedPollData) {
                pollData = JSON.parse(savedPollData);
            }
            
            if (saved) {
                messageHistory = JSON.parse(saved);
                messageHistory.forEach(msg => {
                    if (msg.type === 'poll') {
                        // „Ç¢„É≥„Ç±„Éº„Éà„ÅÆÂæ©ÂÖÉ
                        const messageContainer = document.createElement('div');
                        messageContainer.classList.add('message', msg.sender !== currentUsername ? 'received' : 'sent');
                        messageContainer.dataset.messageId = msg.id;
                        
                        const poll = pollData[msg.pollId];
                        if (poll) {
                            messageContainer.innerHTML = createPollUI(msg.pollId, poll);
                        }
                        
                        chatMessages.appendChild(messageContainer);
                    } else if (msg.type === 'location') {
                        // ‰ΩçÁΩÆÊÉÖÂ†±„ÅÆÂæ©ÂÖÉ
                        const messageContainer = document.createElement('div');
                        messageContainer.classList.add('message', msg.sender !== currentUsername ? 'received' : 'sent');
                        messageContainer.dataset.messageId = msg.id;
                        messageContainer.innerHTML = msg.html;
                        chatMessages.appendChild(messageContainer);
                    } else if (msg.type && msg.fileData) {
                        addMediaMessageToUI(msg.text, msg.sender, msg.time, msg.sender !== currentUsername, msg.fileData, msg.type);
                    } else if (msg.isAnimated && msg.htmlContent) {
                        // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥‰ªò„Åç„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂæ©ÂÖÉ
                        const messageContainer = document.createElement('div');
                        messageContainer.classList.add('message', msg.sender !== currentUsername ? 'received' : 'sent');
                        
                        const senderDiv = document.createElement('div');
                        senderDiv.classList.add('message-sender');
                        senderDiv.textContent = msg.sender;
                        
                        const messageDiv = document.createElement('div');
                        messageDiv.innerHTML = msg.htmlContent;
                        messageDiv.style.fontSize = '30px';
                        
                        const timeDiv = document.createElement('div');
                        timeDiv.classList.add('message-time');
                        timeDiv.textContent = msg.time;
                        
                        messageContainer.appendChild(senderDiv);
                        messageContainer.appendChild(messageDiv);
                        messageContainer.appendChild(timeDiv);
                        
                        chatMessages.appendChild(messageContainer);
                    } else if (msg.type === 'timer') {
                        // „Çø„Ç§„Éû„Éº„ÅÆÂæ©ÂÖÉ
                        const messageContainer = document.createElement('div');
                        messageContainer.classList.add('message', msg.sender !== currentUsername ? 'received' : 'sent');
                        messageContainer.dataset.messageId = msg.id;
                        messageContainer.innerHTML = createTimerUI(msg.timerId, msg.minutes);
                        chatMessages.appendChild(messageContainer);
                        
                        // „Çø„Ç§„Éû„ÉºÂÜçÈñã
                        if (msg.endTime && msg.endTime > Date.now()) {
                            activeTimers[msg.timerId] = {
                                endTime: msg.endTime,
                                interval: null
                            };
                            startTimerInterval(msg.timerId);
                        }
                    } else if (msg.type === 'custom-quiz') {
                        // „Ç´„Çπ„Çø„É†„ÇØ„Ç§„Ç∫„ÅÆÂæ©ÂÖÉ
                        const quizHtml = `
                            <div class="custom-quiz-container" data-quiz-id="${msg.quizId}">
                                <div class="message-sender">${msg.sender} „Åã„Çâ„ÅÆ„ÇØ„Ç§„Ç∫</div>
                                <div class="quiz-question">Q: ${msg.question}</div>
                                <input type="text" class="quiz-answer-input" placeholder="Á≠î„Åà„ÇíÂÖ•Âäõ..." 
                                       onkeypress="if(event.key==='Enter')checkCustomQuiz('${msg.quizId}', '${msg.answer}', this.value)">
                                <button class="game-button" style="margin-top: 10px;" 
                                        onclick="checkCustomQuiz('${msg.quizId}', '${msg.answer}', this.previousElementSibling.value)">
                                    Á≠î„Åà„ÇíÁ¢∫Ë™ç
                                </button>
                            </div>
                        `;
                        const messageContainer = document.createElement('div');
                        messageContainer.classList.add('message', msg.sender !== currentUsername ? 'received' : 'sent');
                        messageContainer.dataset.messageId = msg.id;
                        messageContainer.innerHTML = quizHtml;
                        chatMessages.appendChild(messageContainer);
                    } else {
                        addMessageToUI(msg.text, msg.sender, msg.time, msg.sender !== currentUsername, msg.id);
                    }
                });
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }
        
        // „É°„ÉÉ„Çª„Éº„Ç∏„ÇíLocalStorage„Å´‰øùÂ≠ò
        function saveMessages() {
            localStorage.setItem('chatMessages', JSON.stringify(messageHistory));
            localStorage.setItem('pollData', JSON.stringify(pollData));
        }
        
        // Ëá™‰ΩúÁµµÊñáÂ≠ó„Çí‰øùÂ≠ò
        function saveUserEmojis() {
            localStorage.setItem('userEmojis', JSON.stringify(userEmojis));
        }
        
        // Ëá™‰ΩúÁµµÊñáÂ≠ó„ÇíË™≠„ÅøËæº„Åø
        function loadUserEmojis() {
            const saved = localStorage.getItem('userEmojis');
            if (saved) {
                userEmojis = JSON.parse(saved);
                updateUserEmojiGrid();
            }
        }
        
        // „É¶„Éº„Ç∂„ÉºÂêç„Çí‰øùÂ≠ò
        function saveUsername(username) {
            localStorage.setItem('currentUsername', username);
        }
        
        // „É¶„Éº„Ç∂„ÉºÂêç„ÇíË™≠„ÅøËæº„Åø
        function loadUsername() {
            return localStorage.getItem('currentUsername');
        }
        
        
        // ÂêçÂâçÂÖ•ÂäõÂá¶ÁêÜ
        function submitName() {
            const name = usernameInput.value.trim();
            if (name) {
                currentUsername = name;
                userAvatars[currentUsername] = currentAvatar;
                saveUserAvatars();
                
                currentUserDisplay.textContent = `„É≠„Ç∞„Ç§„É≥‰∏≠: ${currentUsername}`;
                nameInputOverlay.style.display = 'none';
                chatContainer.style.display = 'flex';
                messageInput.focus();
                loadMessages();
                
                // ÂÖ•ÂÆ§„É°„ÉÉ„Çª„Éº„Ç∏
                addSystemMessage(`${currentAvatar} ${currentUsername} „Åï„Çì„ÅåÂÖ•ÂÆ§„Åó„Åæ„Åó„Åü`);
            }
        }
        
        let autoReloadInterval = null;
        
        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„ÅÆÂá¶ÁêÜ
        window.addEventListener('load', () => {
            initEmojiPanel();
            initNotifications();
            initAvatarSelector();
            loadUserAvatars();
            loadUserEmojis();
            initEmojiCreator();
            
            // Â∏∏„Å´ÂêçÂâçÂÖ•Âäõ„ÇíË°®Á§∫ÔºàÊØéÂõûÂêçÂâç„ÇíÊ±∫„ÇÅ„Çâ„Çå„Çã„Çà„ÅÜ„Å´Ôºâ
            nameInputOverlay.style.display = 'flex';
            chatContainer.style.display = 'none';
            usernameInput.focus();
        });
        
        // „Ç¶„Ç£„É≥„Éâ„Ç¶„Éï„Ç©„Éº„Ç´„Çπ„ÅÆÁõ£Ë¶ñ
        window.addEventListener('focus', () => {
            isWindowFocused = true;
            markAllAsRead();
        });
        
        window.addEventListener('blur', () => {
            isWindowFocused = false;
        });
        
        nameSubmitButton.addEventListener('click', submitName);
        
        usernameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                submitName();
            }
        });
        
        // „É°„ÉÉ„Çª„Éº„Ç∏ËøΩÂä†ÔºàUI„ÅÆ„ÅøÔºâ
        function addMessageToUI(text, sender, time, isReceived = true, messageId = null) {
            const messageContainer = document.createElement('div');
            messageContainer.classList.add('message', isReceived ? 'received' : 'sent');
            if (messageId) messageContainer.dataset.messageId = messageId;
            
            // ÂâäÈô§„Éú„Çø„É≥„ÇíËøΩÂä†
            const messageActions = document.createElement('div');
            messageActions.classList.add('message-actions');
            const deleteBtn = document.createElement('button');
            deleteBtn.classList.add('delete-btn');
            deleteBtn.textContent = 'ÂâäÈô§';
            deleteBtn.onclick = () => deleteMessage(messageId || Date.now());
            messageActions.appendChild(deleteBtn);
            messageContainer.appendChild(messageActions);
            
            const senderDiv = document.createElement('div');
            senderDiv.classList.add('message-sender');
            
            // „Ç¢„Éê„Çø„ÉºËøΩÂä†
            const avatar = document.createElement('div');
            avatar.classList.add('avatar');
            avatar.textContent = userAvatars[sender] || sender.charAt(0).toUpperCase();
            avatar.style.backgroundColor = getAvatarColor(sender);
            
            senderDiv.appendChild(avatar);
            const senderName = document.createElement('span');
            senderName.textContent = sender;
            senderDiv.appendChild(senderName);
            
            const messageText = document.createElement('div');
            messageText.textContent = text;
            
            const timeDiv = document.createElement('div');
            timeDiv.classList.add('message-time');
            timeDiv.textContent = time;
            
            messageContainer.appendChild(senderDiv);
            messageContainer.appendChild(messageText);
            messageContainer.appendChild(timeDiv);
            
            // Êó¢Ë™≠Ë°®Á§∫ÔºàÈÄÅ‰ø°„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆ„ÅøÔºâ
            if (!isReceived) {
                const readStatus = document.createElement('div');
                readStatus.classList.add('read-status');
                readStatus.textContent = 'Êó¢Ë™≠';
                messageContainer.appendChild(readStatus);
            } else {
                // Âèó‰ø°„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂ†¥Âêà„ÄÅÊú™Ë™≠„Ç´„Ç¶„É≥„ÉàÊõ¥Êñ∞
                if (!isWindowFocused) {
                    updateUnreadCount(1);
                }
            }
            
            chatMessages.appendChild(messageContainer);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Èü≥Â£∞ÈÄöÁü•ÔºàÂèó‰ø°„É°„ÉÉ„Çª„Éº„Ç∏„Åß„ÄÅ„Ç¶„Ç£„É≥„Éâ„Ç¶„Åå„Éï„Ç©„Éº„Ç´„Çπ„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥ÂêàÔºâ
            if (isReceived && !isWindowFocused) {
                showNotification(sender, text);
            }
        }
        
        // „É°„ÉÉ„Çª„Éº„Ç∏ËøΩÂä†Ôºà‰øùÂ≠ò‰ªò„ÅçÔºâ
        function addMessage(text, sender, isReceived = true) {
            const now = new Date();
            const time = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            const messageId = Date.now();
            
            const message = { text, sender, time, id: messageId };
            messageHistory.push(message);
            saveMessages();
            
            addMessageToUI(text, sender, time, isReceived, messageId);
        }
        
        // „Ç∑„Çπ„ÉÜ„É†„É°„ÉÉ„Çª„Éº„Ç∏ËøΩÂä†
        function addSystemMessage(text) {
            const messageContainer = document.createElement('div');
            messageContainer.style.textAlign = 'center';
            messageContainer.style.margin = '10px 0';
            messageContainer.style.color = '#666';
            messageContainer.style.fontSize = '14px';
            messageContainer.style.fontStyle = 'italic';
            messageContainer.textContent = text;
            
            chatMessages.appendChild(messageContainer);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // „É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°Âá¶ÁêÜ
        function sendMessage() {
            const message = messageInput.value.trim();
            if (message) {
                addMessage(message, currentUsername, false);
                messageInput.value = '';
                
                // Á∞°Âçò„Å™Ëá™ÂãïËøî‰ø°„Éá„É¢ÔºàÈÄÅ‰ø°ÂæåÂ∞ë„ÅóÁµå„Å£„Å¶„Åã„ÇâÔºâ
                setTimeout(() => {
                    if (message.includes('„Åì„Çì„Å´„Å°„ÅØ') || message.includes('„Åä„ÅØ„Çà„ÅÜ')) {
                        addMessage('„Åì„Çì„Å´„Å°„ÅØÔºÅÂÖÉÊ∞ó„Åß„Åô„ÅãÔºü', '„ÉÜ„Çπ„Éà„É¶„Éº„Ç∂„Éº', true);
                    } else if (message.includes('„ÉÜ„Çπ„Éà')) {
                        addMessage('„ÉÜ„Çπ„Éà„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂèó‰ø°„Åó„Åæ„Åó„ÅüÔºÅ', '„Éú„ÉÉ„Éà', true);
                    }
                }, 1000);
            }
        }
        
        sendButton.addEventListener('click', sendMessage);
        
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // „Éï„Ç°„Ç§„É´ÈÄÅ‰ø°Ê©üËÉΩ
        fileButton.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleFileUpload(file);
            }
        });
        
        // „Éö„Éº„Çπ„Éà„Ç§„Éô„É≥„Éà„ÅßÁîªÂÉè„ÇíÂèó„Åë‰ªò„Åë
        document.addEventListener('paste', (e) => {
            const items = e.clipboardData.items;
            
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                
                if (item.type.indexOf('image') !== -1) {
                    e.preventDefault();
                    const blob = item.getAsFile();
                    const file = new File([blob], `paste_${Date.now()}.png`, { type: blob.type });
                    handleFileUpload(file);
                    break;
                }
            }
        });
        
        // „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂá¶ÁêÜ
        function handleFileUpload(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const fileData = {
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    data: e.target.result
                };
                
                if (file.type.startsWith('image/')) {
                    addMediaMessage(`üñºÔ∏è ÁîªÂÉè: ${file.name}`, fileData, 'image');
                } else {
                    addMediaMessage(`üìÅ „Éï„Ç°„Ç§„É´: ${file.name} (${formatFileSize(file.size)})`, fileData, 'file');
                }
            };
            
            reader.readAsDataURL(file);
        }
        
        // „É°„Éá„Ç£„Ç¢„É°„ÉÉ„Çª„Éº„Ç∏ËøΩÂä†
        function addMediaMessage(text, fileData, type) {
            const now = new Date();
            const time = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            
            const message = { text, sender: currentUsername, time, fileData, type };
            messageHistory.push(message);
            saveMessages();
            
            addMediaMessageToUI(text, currentUsername, time, false, fileData, type);
        }
        
        // „É°„Éá„Ç£„Ç¢„É°„ÉÉ„Çª„Éº„Ç∏UIËøΩÂä†
        function addMediaMessageToUI(text, sender, time, isReceived, fileData, type) {
            const messageContainer = document.createElement('div');
            messageContainer.classList.add('message', isReceived ? 'received' : 'sent');
            
            const senderDiv = document.createElement('div');
            senderDiv.classList.add('message-sender');
            senderDiv.textContent = sender;
            
            const mediaDiv = document.createElement('div');
            mediaDiv.classList.add('media-message');
            
            if (type === 'image') {
                const img = document.createElement('img');
                img.src = fileData.data || fileData;
                img.alt = fileData.name || 'image';
                img.onload = () => console.log('ÁîªÂÉè„ÅåÊ≠£Â∏∏„Å´Ë™≠„ÅøËæº„Åæ„Çå„Åæ„Åó„Åü');
                img.onerror = () => {
                    console.error('ÁîªÂÉè„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    img.style.display = 'none';
                    const errorText = document.createElement('div');
                    errorText.textContent = '(ÁîªÂÉè„ÅåË°®Á§∫„Åß„Åç„Åæ„Åõ„Çì)';
                    errorText.style.color = '#dc3545';
                    mediaDiv.appendChild(errorText);
                };
                mediaDiv.appendChild(img);
            } else {
                const link = document.createElement('a');
                link.href = fileData.data;
                link.download = fileData.name;
                link.className = 'file-link';
                link.textContent = `„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ: ${fileData.name}`;
                mediaDiv.appendChild(link);
            }
            
            const messageText = document.createElement('div');
            messageText.textContent = text;
            
            const timeDiv = document.createElement('div');
            timeDiv.classList.add('message-time');
            timeDiv.textContent = time;
            
            messageContainer.appendChild(senderDiv);
            messageContainer.appendChild(mediaDiv);
            messageContainer.appendChild(messageText);
            messageContainer.appendChild(timeDiv);
            
            chatMessages.appendChild(messageContainer);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„Éï„Ç©„Éº„Éû„ÉÉ„Éà
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // ÂêçÂâçÂ§âÊõ¥Ê©üËÉΩ
        function changeName() {
            const newName = prompt('Êñ∞„Åó„ÅÑÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', currentUsername);
            if (newName && newName.trim() && newName.trim() !== currentUsername) {
                const oldName = currentUsername;
                currentUsername = newName.trim();
                currentUserDisplay.textContent = `„É≠„Ç∞„Ç§„É≥‰∏≠: ${currentUsername}`;
                addSystemMessage(`${oldName} „Åå ${currentUsername} „Å´ÂêçÂâç„ÇíÂ§âÊõ¥„Åó„Åæ„Åó„Åü`);
            }
        }
        
        // ‰øÆÊ≠£„Éú„Çø„É≥Ë°®Á§∫
        function showFixButton() {
            const indicator = document.createElement('div');
            indicator.className = 'fix-indicator';
            indicator.innerHTML = 'üí¨ ÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åô„ÅãÔºü <button class="fix-button" onclick="location.reload()">Êõ¥Êñ∞</button>';
            document.body.appendChild(indicator);
            indicator.style.display = 'block';
            
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.parentNode.removeChild(indicator);
                }
            }, 5000);
        }
        
        // „É°„ÉÉ„Çª„Éº„Ç∏ÂÜçË™≠„ÅøËæº„Åø
        function reloadMessages() {
            chatMessages.innerHTML = '';
            loadMessages();
            addSystemMessage('„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Åæ„Åó„Åü');
        }
        
        // „ÉÅ„É£„ÉÉ„Éà„ÇØ„É™„Ç¢
        function clearChat() {
            if (confirm('„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                messageHistory = [];
                saveMessages();
                chatMessages.innerHTML = '';
                addSystemMessage('„ÉÅ„É£„ÉÉ„Éà„Åå„ÇØ„É™„Ç¢„Åï„Çå„Åæ„Åó„Åü');
            }
        }
        
        // ÁµµÊñáÂ≠ó„Éë„Éç„É´„ÅÆÂàùÊúüÂåñ
        function initEmojiPanel() {
            // Âü∫Êú¨ÁµµÊñáÂ≠ó
            const basicGrid = document.getElementById('basicEmojis');
            basicEmojis.forEach(emoji => {
                const item = document.createElement('div');
                item.className = 'emoji-item';
                item.textContent = emoji;
                item.onclick = () => insertEmoji(emoji);
                basicGrid.appendChild(item);
            });
            
            // Âãï„ÅèÁµµÊñáÂ≠ó
            const animatedGrid = document.getElementById('animatedEmojis');
            animatedEmojis.forEach(item => {
                const div = document.createElement('div');
                div.className = 'emoji-item';
                div.innerHTML = `<span class="animated-emoji ${item.class}">${item.emoji}</span>`;
                div.onclick = () => insertAnimatedEmoji(item.emoji, item.class);
                div.title = item.name;
                animatedGrid.appendChild(div);
            });
            
            // ÁâπÂà•ÁµµÊñáÂ≠ó
            const specialGrid = document.getElementById('specialEmojis');
            specialEmojis.forEach(emoji => {
                const item = document.createElement('div');
                item.className = 'emoji-item';
                item.textContent = emoji;
                item.onclick = () => insertEmoji(emoji);
                specialGrid.appendChild(item);
            });
            
            // „Ç™„É™„Ç∏„Éä„É´ÁµµÊñáÂ≠ó
            const customGrid = document.getElementById('customEmojis');
            customEmojis.forEach(item => {
                const div = document.createElement('div');
                div.className = 'emoji-item';
                div.innerHTML = `<span class="${item.class}">${item.text}</span>`;
                div.onclick = () => insertCustomEmoji(item.text, item.class);
                div.title = item.name;
                customGrid.appendChild(div);
            });
            
            // „Ç¢„Ç§„Ç≥„É≥ÁµµÊñáÂ≠ó
            const iconGrid = document.getElementById('iconEmojis');
            iconEmojis.forEach(item => {
                const div = document.createElement('div');
                div.className = 'emoji-item';
                div.innerHTML = `<span class="${item.class}"></span>`;
                div.onclick = () => insertIconEmoji(item.icon, item.class);
                div.title = item.name;
                iconGrid.appendChild(div);
            });
        }
        
        // ÁµµÊñáÂ≠ó„Çí„É°„ÉÉ„Çª„Éº„Ç∏ÂÖ•ÂäõÊ¨Ñ„Å´ÊåøÂÖ•
        function insertEmoji(emoji) {
            const input = messageInput;
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const text = input.value;
            input.value = text.substring(0, start) + emoji + text.substring(end);
            input.focus();
            input.selectionStart = input.selectionEnd = start + emoji.length;
            emojiPanel.style.display = 'none';
        }
        
        // Âãï„ÅèÁµµÊñáÂ≠ó„Çí„É°„ÉÉ„Çª„Éº„Ç∏„Å®„Åó„Å¶ÈÄÅ‰ø°
        function insertAnimatedEmoji(emoji, animationClass) {
            const animatedMessage = `<span class="animated-emoji ${animationClass}">${emoji}</span>`;
            addAnimatedMessage(animatedMessage, currentUsername, false);
            emojiPanel.style.display = 'none';
        }
        
        // „Ç™„É™„Ç∏„Éä„É´ÁµµÊñáÂ≠ó„Çí„É°„ÉÉ„Çª„Éº„Ç∏„Å®„Åó„Å¶ÈÄÅ‰ø°
        function insertCustomEmoji(text, cssClass) {
            const customMessage = `<span class="${cssClass}">${text}</span>`;
            addAnimatedMessage(customMessage, currentUsername, false);
            emojiPanel.style.display = 'none';
        }
        
        // „Ç¢„Ç§„Ç≥„É≥ÁµµÊñáÂ≠ó„Çí„É°„ÉÉ„Çª„Éº„Ç∏„Å®„Åó„Å¶ÈÄÅ‰ø°
        function insertIconEmoji(icon, cssClass) {
            const iconMessage = `<span class="${cssClass}"></span>`;
            addAnimatedMessage(iconMessage, currentUsername, false);
            emojiPanel.style.display = 'none';
        }
        
        // ÁµµÊñáÂ≠ó„Éë„Éç„É´„ÅÆË°®Á§∫/ÈùûË°®Á§∫Âàá„ÇäÊõø„Åà
        emojiButton.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (emojiPanel.style.display === 'none' || !emojiPanel.style.display) {
                emojiPanel.style.display = 'block';
                toolsPanel.style.display = 'none';
            } else {
                emojiPanel.style.display = 'none';
            }
        });
        
        // „ÉÑ„Éº„É´„Éë„Éç„É´„ÅÆË°®Á§∫/ÈùûË°®Á§∫Âàá„ÇäÊõø„Åà
        toolsButton.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (toolsPanel.style.display === 'none' || !toolsPanel.style.display) {
                toolsPanel.style.display = 'block';
                emojiPanel.style.display = 'none';
            } else {
                toolsPanel.style.display = 'none';
            }
        });
        
        // „ÇØ„É™„ÉÉ„ÇØ„Åß„Éë„Éç„É´„ÇíÈñâ„Åò„Çã
        document.addEventListener('click', (e) => {
            if (!emojiButton.contains(e.target) && !emojiPanel.contains(e.target)) {
                emojiPanel.style.display = 'none';
            }
            if (!toolsButton.contains(e.target) && !toolsPanel.contains(e.target)) {
                toolsPanel.style.display = 'none';
            }
        });
        
        
        // ÈÄöÁü•Ê©üËÉΩ„ÅÆÂàùÊúüÂåñ
        function initNotifications() {
            // ÈÄöÁü•Ë®±ÂèØ„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
            if ('Notification' in window && Notification.permission === 'default') {
                setTimeout(() => {
                    notificationPermission.style.display = 'block';
                }, 2000);
            }
        }
        
        // ÈÄöÁü•„ÇíÊúâÂäπ„Å´„Åô„Çã
        function enableNotifications() {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    notificationPermission.style.display = 'none';
                    new Notification('„ÉÅ„É£„ÉÉ„ÉàÈÄöÁü•„ÅåÊúâÂäπ„Å´„Å™„Çä„Åæ„Åó„ÅüÔºÅ', {
                        icon: 'üí¨',
                        body: 'Êñ∞„Åó„ÅÑ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂèó‰ø°„Åô„Çã„Å®ÈÄöÁü•„Åï„Çå„Åæ„Åô„ÄÇ'
                    });
                }
            });
        }
        
        // ÈÄöÁü•„Éó„É≠„É≥„Éó„Éà„ÇíÈñâ„Åò„Çã
        function dismissNotificationPrompt() {
            notificationPermission.style.display = 'none';
        }
        
        // Èü≥Â£∞ÈÄöÁü•„ÇíÂÜçÁîü
        function showNotification(sender, message) {
            // Èü≥Â£∞ÈÄöÁü•„Çí‰ΩúÊàê
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // ÈÄöÁü•Èü≥„ÅÆË®≠ÂÆöÔºàÁü≠„ÅÑ„Éî„Éº„ÉóÈü≥Ôºâ
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
            
            // „Ç≥„É≥„ÇΩ„Éº„É´„Å´„ÇÇÈÄöÁü•
            console.log(`üîî ${sender}„Åã„Çâ„É°„ÉÉ„Çª„Éº„Ç∏: ${message}`);
        }
        
        // Êú™Ë™≠„Ç´„Ç¶„É≥„ÉàÊõ¥Êñ∞
        function updateUnreadCount(increment) {
            unreadCount += increment;
            if (unreadCount > 0) {
                unreadIndicator.textContent = unreadCount;
                unreadIndicator.style.display = 'inline-flex';
                document.title = `(${unreadCount}) „ÉÅ„É£„ÉÉ„Éà`;
            } else {
                unreadIndicator.style.display = 'none';
                document.title = '„ÉÅ„É£„ÉÉ„Éà';
            }
        }
        
        // ÂÖ®„Å¶Êó¢Ë™≠„Å´„Åô„Çã
        function markAllAsRead() {
            unreadCount = 0;
            updateUnreadCount(0);
            lastReadTime = new Date();
        }
        
        // Âãï„ÅèÁµµÊñáÂ≠ó„É°„ÉÉ„Çª„Éº„Ç∏„ÇíËøΩÂä†ÔºàÂèó‰ø°Áî®Ôºâ
        function addAnimatedMessage(htmlContent, sender, isReceived) {
            const now = new Date();
            const time = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            
            const message = { htmlContent, sender, time, isAnimated: true };
            messageHistory.push(message);
            saveMessages();
            
            const messageContainer = document.createElement('div');
            messageContainer.classList.add('message', isReceived ? 'received' : 'sent');
            
            const senderDiv = document.createElement('div');
            senderDiv.classList.add('message-sender');
            senderDiv.textContent = sender;
            
            const messageDiv = document.createElement('div');
            messageDiv.innerHTML = htmlContent;
            messageDiv.style.fontSize = '30px';
            
            const timeDiv = document.createElement('div');
            timeDiv.classList.add('message-time');
            timeDiv.textContent = time;
            
            messageContainer.appendChild(senderDiv);
            messageContainer.appendChild(messageDiv);
            messageContainer.appendChild(timeDiv);
            
            // Êó¢Ë™≠Ë°®Á§∫ÔºàÈÄÅ‰ø°„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆ„ÅøÔºâ
            if (!isReceived) {
                const readStatus = document.createElement('div');
                readStatus.classList.add('read-status');
                readStatus.textContent = 'Êó¢Ë™≠';
                messageContainer.appendChild(readStatus);
            } else {
                // Âèó‰ø°„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂ†¥Âêà„ÄÅÊú™Ë™≠„Ç´„Ç¶„É≥„ÉàÊõ¥Êñ∞
                if (!isWindowFocused) {
                    updateUnreadCount(1);
                }
            }
            
            chatMessages.appendChild(messageContainer);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Èü≥Â£∞ÈÄöÁü•ÔºàÂèó‰ø°„É°„ÉÉ„Çª„Éº„Ç∏„Åß„ÄÅ„Ç¶„Ç£„É≥„Éâ„Ç¶„Åå„Éï„Ç©„Éº„Ç´„Çπ„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥ÂêàÔºâ
            if (isReceived && !isWindowFocused) {
                showNotification(sender, 'ÁµµÊñáÂ≠ó„É°„ÉÉ„Çª„Éº„Ç∏');
            }
        }
        
        // „É°„ÉÉ„Çª„Éº„Ç∏ÂâäÈô§
        function deleteMessage(messageId) {
            if (confirm('„Åì„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                // „É°„ÉÉ„Çª„Éº„Ç∏Â±•Ê≠¥„Åã„ÇâÂâäÈô§
                messageHistory = messageHistory.filter(msg => msg.id !== messageId);
                saveMessages();
                
                // UI„Åã„ÇâÂâäÈô§
                const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                if (messageElement) {
                    messageElement.remove();
                }
                
                addSystemMessage('„É°„ÉÉ„Çª„Éº„Ç∏„ÅåÂâäÈô§„Åï„Çå„Åæ„Åó„Åü');
            }
        }
        
        // „Ç¢„É≥„Ç±„Éº„Éà‰ΩúÊàê
        function createPoll() {
            const question = prompt('„Ç¢„É≥„Ç±„Éº„Éà„ÅÆË≥™Âïè„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
            if (!question) return;
            
            const options = [];
            let optionCount = 1;
            while (optionCount <= 4) {
                const option = prompt(`ÈÅ∏ÊäûËÇ¢${optionCount}„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ (Á©∫Ê¨Ñ„ÅßÁµÇ‰∫Ü):`);
                if (!option) break;
                options.push(option);
                optionCount++;
            }
            
            if (options.length < 2) {
                alert('ÈÅ∏ÊäûËÇ¢„ÅØ2„Å§‰ª•‰∏äÂøÖË¶Å„Åß„Åô');
                return;
            }
            
            const pollId = 'poll_' + Date.now();
            pollData[pollId] = {
                question: question,
                sender: currentUsername,
                options: options.map((opt, idx) => ({
                    id: idx,
                    text: opt,
                    votes: []
                }))
            };
            
            // „Ç¢„É≥„Ç±„Éº„ÉàUI„Çí‰ΩúÊàê
            const pollHtml = createPollUI(pollId, pollData[pollId]);
            const now = new Date();
            const time = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            
            const message = {
                type: 'poll',
                pollId: pollId,
                sender: currentUsername,
                time: time,
                id: Date.now()
            };
            messageHistory.push(message);
            saveMessages();
            
            // „Ç¢„É≥„Ç±„Éº„Éà„ÇíË°®Á§∫
            const messageContainer = document.createElement('div');
            messageContainer.classList.add('message', 'sent');
            messageContainer.dataset.messageId = message.id;
            
            // ÂâäÈô§„Éú„Çø„É≥„ÇíËøΩÂä†
            const messageActions = document.createElement('div');
            messageActions.classList.add('message-actions');
            const deleteBtn = document.createElement('button');
            deleteBtn.classList.add('delete-btn');
            deleteBtn.textContent = 'ÂâäÈô§';
            deleteBtn.onclick = () => deleteMessage(message.id);
            messageActions.appendChild(deleteBtn);
            messageContainer.appendChild(messageActions);
            
            messageContainer.innerHTML += pollHtml;
            chatMessages.appendChild(messageContainer);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            toolsPanel.style.display = 'none';
        }
        
        // „Ç¢„É≥„Ç±„Éº„ÉàUI‰ΩúÊàê
        function createPollUI(pollId, poll) {
            let html = `
                <div class="poll-container">
                    <div class="message-sender">${poll.sender || '„Ç¢„É≥„Ç±„Éº„Éà'}</div>
                    <div class="poll-title">üìä ${poll.question}</div>
            `;
            
            poll.options.forEach((option, idx) => {
                const voteCount = option.votes.length;
                const voted = option.votes.includes(currentUsername);
                html += `
                    <div class="poll-option ${voted ? 'voted' : ''}" onclick="votePoll('${pollId}', ${idx})">
                        <span>${option.text}</span>
                        <span class="poll-votes">${voteCount}Á•®</span>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }
        
        // ÊäïÁ•®
        function votePoll(pollId, optionId) {
            const poll = pollData[pollId];
            if (!poll) return;
            
            // Êó¢Â≠ò„ÅÆÊäïÁ•®„ÇíÂâäÈô§
            poll.options.forEach(option => {
                option.votes = option.votes.filter(v => v !== currentUsername);
            });
            
            // Êñ∞„Åó„ÅÑÊäïÁ•®„ÇíËøΩÂä†
            poll.options[optionId].votes.push(currentUsername);
            
            // „Éá„Éº„Çø„Çí‰øùÂ≠ò
            saveMessages();
            
            // UI„ÇíÊõ¥Êñ∞
            const pollContainers = document.querySelectorAll('.poll-container');
            pollContainers.forEach(container => {
                const parent = container.parentElement;
                if (parent && parent.dataset.messageId) {
                    // Êó¢Â≠ò„ÅÆHTML„ÇíÊõ¥Êñ∞
                    const newPollHtml = createPollUI(pollId, poll);
                    const temp = document.createElement('div');
                    temp.innerHTML = newPollHtml;
                    container.replaceWith(temp.firstChild);
                }
            });
        }
        
        // „ÇØ„Ç§„Ç∫ÈñãÂßã
        function startQuiz() {
            const quizzes = [
                { q: 'Êó•Êú¨„ÅÆÈ¶ñÈÉΩ„ÅØÔºü', a: 'Êù±‰∫¨' },
                { q: '1+1„ÅØÔºü', a: '2' },
                { q: 'Ëôπ„ÅÆËâ≤„ÅØ‰ΩïËâ≤Ôºü', a: '7' },
                { q: 'Âú∞ÁêÉ„ÅØÂ§™ÈôΩ„ÅÆÂë®„Çä„Çí‰ΩïÊó•„Åß‰∏ÄÂë®„Åô„ÇãÔºü', a: '365' }
            ];
            
            const quiz = quizzes[Math.floor(Math.random() * quizzes.length)];
            currentGame = { type: 'quiz', answer: quiz.a };
            
            const gameHtml = `
                <div class="game-container">
                    <div class="game-title">‚ùì „ÇØ„Ç§„Ç∫„Çø„Ç§„É†ÔºÅ</div>
                    <div>${quiz.q}</div>
                    <div style="margin-top: 10px; font-size: 12px;">„ÉÅ„É£„ÉÉ„Éà„ÅßÁ≠î„Åà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ</div>
                </div>
            `;
            
            addGameMessage(gameHtml);
            toolsPanel.style.display = 'none';
        }
        
        // „Åó„Çä„Å®„ÇäÈñãÂßã
        function startShiritori() {
            currentGame = { type: 'shiritori', lastWord: '„Åó„Çä„Å®„Çä', lastChar: '„Çä' };
            
            const gameHtml = `
                <div class="game-container">
                    <div class="game-title">üî§ „Åó„Çä„Å®„Çä„Ç≤„Éº„É†ÔºÅ</div>
                    <div>ÊúÄÂàù„ÅÆË®ÄËëâ: <strong>„Åó„Çä„Å®„Çä</strong></div>
                    <div>„Äå„Çä„Äç„Åã„ÇâÂßã„Åæ„ÇãË®ÄËëâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ</div>
                </div>
            `;
            
            addGameMessage(gameHtml);
            toolsPanel.style.display = 'none';
        }
        
        // „Åò„ÇÉ„Çì„Åë„ÇìÈñãÂßã
        function startJanken() {
            currentGame = { type: 'janken' };
            
            const gameHtml = `
                <div class="game-container">
                    <div class="game-title">‚úä „Åò„ÇÉ„Çì„Åë„Çì„Éù„É≥ÔºÅ</div>
                    <button class="game-button" onclick="playJanken('„Ç∞„Éº')">‚úä „Ç∞„Éº</button>
                    <button class="game-button" onclick="playJanken('„ÉÅ„Éß„Ç≠')">‚úåÔ∏è „ÉÅ„Éß„Ç≠</button>
                    <button class="game-button" onclick="playJanken('„Éë„Éº')">üñêÔ∏è „Éë„Éº</button>
                </div>
            `;
            
            addGameMessage(gameHtml);
            toolsPanel.style.display = 'none';
        }
        
        // „Åò„ÇÉ„Çì„Åë„Çì„Éó„É¨„Ç§
        function playJanken(playerChoice) {
            const choices = ['„Ç∞„Éº', '„ÉÅ„Éß„Ç≠', '„Éë„Éº'];
            const cpuChoice = choices[Math.floor(Math.random() * 3)];
            
            let result = '';
            if (playerChoice === cpuChoice) {
                result = '„ÅÇ„ÅÑ„ÅìÔºÅ';
            } else if (
                (playerChoice === '„Ç∞„Éº' && cpuChoice === '„ÉÅ„Éß„Ç≠') ||
                (playerChoice === '„ÉÅ„Éß„Ç≠' && cpuChoice === '„Éë„Éº') ||
                (playerChoice === '„Éë„Éº' && cpuChoice === '„Ç∞„Éº')
            ) {
                result = '„ÅÇ„Å™„Åü„ÅÆÂãù„Å°ÔºÅüéâ';
            } else {
                result = '„ÅÇ„Å™„Åü„ÅÆË≤†„Åë...üò¢';
            }
            
            addMessage(`„Åò„ÇÉ„Çì„Åë„ÇìÁµêÊûú: „ÅÇ„Å™„Åü(${playerChoice}) vs CPU(${cpuChoice}) ‚Üí ${result}`, '„Ç≤„Éº„É†', true);
            currentGame = null;
        }
        
        // „Ç≤„Éº„É†„É°„ÉÉ„Çª„Éº„Ç∏ËøΩÂä†
        function addGameMessage(html) {
            const now = new Date();
            const time = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            
            const messageContainer = document.createElement('div');
            messageContainer.classList.add('message', 'received');
            messageContainer.innerHTML = html;
            
            chatMessages.appendChild(messageContainer);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // ‰ΩçÁΩÆÊÉÖÂ†±ÂÖ±Êúâ
        function shareLocation() {
            if (!navigator.geolocation) {
                alert('„Åä‰Ωø„ÅÑ„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØ‰ΩçÁΩÆÊÉÖÂ†±„Çí„Çµ„Éù„Éº„Éà„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const mapUrl = `https://www.google.com/maps?q=${lat},${lng}`;
                    
                    const locationHtml = `
                        <div class="location-container">
                            üìç ÁèæÂú®‰ΩçÁΩÆ„ÇíÂÖ±Êúâ„Åó„Åæ„Åó„Åü<br>
                            <a href="${mapUrl}" target="_blank" class="location-link">Âú∞Âõ≥„ÅßË¶ã„Çã</a>
                        </div>
                    `;
                    
                    const now = new Date();
                    const time = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                    const messageId = Date.now();
                    
                    const message = {
                        type: 'location',
                        html: locationHtml,
                        sender: currentUsername,
                        time: time,
                        id: messageId
                    };
                    
                    messageHistory.push(message);
                    saveMessages();
                    
                    const messageContainer = document.createElement('div');
                    messageContainer.classList.add('message', 'sent');
                    messageContainer.dataset.messageId = messageId;
                    messageContainer.innerHTML = locationHtml;
                    chatMessages.appendChild(messageContainer);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    
                    toolsPanel.style.display = 'none';
                },
                (error) => {
                    alert('‰ΩçÁΩÆÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                }
            );
        }
        
        // „É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°Âá¶ÁêÜ„ÇíÊõ¥Êñ∞Ôºà„Ç≤„Éº„É†ÂØæÂøúÔºâ
        const originalSendMessage = sendMessage;
        sendMessage = function() {
            const message = messageInput.value.trim();
            if (!message) return;
            
            // „Ç≤„Éº„É†‰∏≠„ÅÆÂá¶ÁêÜ
            if (currentGame) {
                if (currentGame.type === 'quiz') {
                    if (message === currentGame.answer) {
                        addMessage('Ê≠£Ëß£ÔºÅüéâ', '„Ç≤„Éº„É†', true);
                        currentGame = null;
                    } else {
                        addMessage('‰∏çÊ≠£Ëß£...„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÔºÅ', '„Ç≤„Éº„É†', true);
                    }
                } else if (currentGame.type === 'shiritori') {
                    if (message.charAt(0) === currentGame.lastChar) {
                        const lastChar = message.charAt(message.length - 1);
                        if (lastChar === '„Çì') {
                            addMessage(`„Äå${message}„Äç„ÅßÁµÇ„Çè„Çä„Åæ„Åó„ÅüÔºÅ„ÅÇ„Å™„Åü„ÅÆË≤†„Åë„Åß„Åôüò¢`, '„Ç≤„Éº„É†', true);
                            currentGame = null;
                        } else {
                            currentGame.lastWord = message;
                            currentGame.lastChar = lastChar;
                            addMessage(`„Äå${message}„Äç‚Üí Ê¨°„ÅØ„Äå${lastChar}„Äç„Åã„ÇâÂßã„Åæ„ÇãË®ÄËëâÔºÅ`, '„Ç≤„Éº„É†', true);
                        }
                    } else {
                        addMessage(`„Äå${currentGame.lastChar}„Äç„Åã„ÇâÂßã„Åæ„ÇãË®ÄËëâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ`, '„Ç≤„Éº„É†', true);
                    }
                    messageInput.value = '';
                    return;
                }
            }
            
            originalSendMessage();
        };
        
        // „Ç¢„Éê„Çø„Éº„Çª„É¨„ÇØ„Çø„ÉºÂàùÊúüÂåñ
        function initAvatarSelector() {
            const avatarOptions = document.querySelectorAll('.avatar-option');
            avatarOptions.forEach(option => {
                option.addEventListener('click', function() {
                    avatarOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    currentAvatar = this.dataset.avatar;
                });
            });
            
            // „Éá„Éï„Ç©„É´„ÉàÈÅ∏Êäû
            avatarOptions[0].classList.add('selected');
        }
        
        // „Ç¢„Éê„Çø„ÉºÊÉÖÂ†±‰øùÂ≠ò
        function saveUserAvatars() {
            localStorage.setItem('userAvatars', JSON.stringify(userAvatars));
        }
        
        // „Ç¢„Éê„Çø„ÉºÊÉÖÂ†±Ë™≠„ÅøËæº„Åø
        function loadUserAvatars() {
            const saved = localStorage.getItem('userAvatars');
            if (saved) {
                userAvatars = JSON.parse(saved);
            }
        }
        
        // „Ç¢„Éê„Çø„ÉºËâ≤ÁîüÊàê
        function getAvatarColor(username) {
            const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#e67e22', '#34495e'];
            let hash = 0;
            for (let i = 0; i < username.length; i++) {
                hash = username.charCodeAt(i) + ((hash << 5) - hash);
            }
            return colors[Math.abs(hash) % colors.length];
        }
        
        // „Çø„Ç§„Éû„ÉºÈñãÂßã
        function startTimer() {
            const minutes = prompt('„Çø„Ç§„Éû„Éº„ÅÆÊôÇÈñì„ÇíÂàÜ„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
            if (!minutes || isNaN(minutes)) return;
            
            const timerId = 'timer_' + Date.now();
            const endTime = Date.now() + (parseInt(minutes) * 60 * 1000);
            
            activeTimers[timerId] = {
                endTime: endTime,
                interval: null
            };
            
            const timerHtml = createTimerUI(timerId, parseInt(minutes));
            
            const now = new Date();
            const time = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            const messageId = Date.now();
            
            const message = {
                type: 'timer',
                timerId: timerId,
                minutes: parseInt(minutes),
                endTime: endTime,
                sender: currentUsername,
                time: time,
                id: messageId
            };
            
            messageHistory.push(message);
            saveMessages();
            
            const messageContainer = document.createElement('div');
            messageContainer.classList.add('message', 'sent');
            messageContainer.dataset.messageId = messageId;
            messageContainer.innerHTML = timerHtml;
            chatMessages.appendChild(messageContainer);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            startTimerInterval(timerId);
            toolsPanel.style.display = 'none';
        }
        
        // „Çø„Ç§„Éû„ÉºUI‰ΩúÊàê
        function createTimerUI(timerId, minutes) {
            return `
                <div class="timer-container" id="${timerId}">
                    <div class="message-sender">${currentUsername}</div>
                    <div>‚è∞ „Çø„Ç§„Éû„ÉºË®≠ÂÆö: ${minutes}ÂàÜ</div>
                    <div class="timer-display" id="${timerId}_display">--:--</div>
                    <div class="timer-controls">
                        <button class="timer-button" onclick="pauseTimer('${timerId}')">‚è∏Ô∏è ‰∏ÄÊôÇÂÅúÊ≠¢</button>
                        <button class="timer-button" onclick="stopTimer('${timerId}')">‚èπÔ∏è ÂÅúÊ≠¢</button>
                    </div>
                </div>
            `;
        }
        
        // „Çø„Ç§„Éû„ÉºÊõ¥Êñ∞
        function startTimerInterval(timerId) {
            const timer = activeTimers[timerId];
            if (!timer) return;
            
            timer.interval = setInterval(() => {
                const remaining = timer.endTime - Date.now();
                const display = document.getElementById(timerId + '_display');
                
                if (display) {
                    if (remaining <= 0) {
                        display.textContent = 'ÁµÇ‰∫ÜÔºÅ';
                        addSystemMessage('‚è∞ „Çø„Ç§„Éû„Éº„ÅåÁµÇ‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ');
                        if (Notification.permission === 'granted') {
                            new Notification('„Çø„Ç§„Éû„ÉºÁµÇ‰∫Ü', {
                                body: 'Ë®≠ÂÆö„Åó„ÅüÊôÇÈñì„ÅåÁµåÈÅé„Åó„Åæ„Åó„Åü',
                                icon: '‚è∞'
                            });
                        }
                        clearInterval(timer.interval);
                        delete activeTimers[timerId];
                    } else {
                        const minutes = Math.floor(remaining / 60000);
                        const seconds = Math.floor((remaining % 60000) / 1000);
                        display.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    }
                }
            }, 1000);
        }
        
        // „Çø„Ç§„Éû„Éº‰∏ÄÊôÇÂÅúÊ≠¢
        function pauseTimer(timerId) {
            const timer = activeTimers[timerId];
            if (timer && timer.interval) {
                clearInterval(timer.interval);
                timer.interval = null;
            }
        }
        
        // „Çø„Ç§„Éû„ÉºÂÅúÊ≠¢
        function stopTimer(timerId) {
            const timer = activeTimers[timerId];
            if (timer) {
                if (timer.interval) {
                    clearInterval(timer.interval);
                }
                delete activeTimers[timerId];
                const display = document.getElementById(timerId + '_display');
                if (display) {
                    display.textContent = 'ÂÅúÊ≠¢Ê∏à„Åø';
                }
            }
        }
        
        // „Ç´„Çπ„Çø„É†„ÇØ„Ç§„Ç∫‰ΩúÊàê
        function createCustomQuiz() {
            const question = prompt('„ÇØ„Ç§„Ç∫„ÅÆÂïèÈ°å„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
            if (!question) return;
            
            const answer = prompt('Á≠î„Åà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
            if (!answer) return;
            
            const quizId = 'quiz_' + Date.now();
            const quizHtml = `
                <div class="custom-quiz-container" data-quiz-id="${quizId}">
                    <div class="message-sender">${currentUsername} „Åã„Çâ„ÅÆ„ÇØ„Ç§„Ç∫</div>
                    <div class="quiz-question">Q: ${question}</div>
                    <input type="text" class="quiz-answer-input" placeholder="Á≠î„Åà„ÇíÂÖ•Âäõ..." 
                           onkeypress="if(event.key==='Enter')checkCustomQuiz('${quizId}', '${answer}', this.value)">
                    <button class="game-button" style="margin-top: 10px;" 
                            onclick="checkCustomQuiz('${quizId}', '${answer}', this.previousElementSibling.value)">
                        Á≠î„Åà„ÇíÁ¢∫Ë™ç
                    </button>
                </div>
            `;
            
            const now = new Date();
            const time = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            const messageId = Date.now();
            
            const message = {
                type: 'custom-quiz',
                quizId: quizId,
                question: question,
                answer: answer,
                sender: currentUsername,
                time: time,
                id: messageId
            };
            
            messageHistory.push(message);
            saveMessages();
            
            const messageContainer = document.createElement('div');
            messageContainer.classList.add('message', 'sent');
            messageContainer.dataset.messageId = messageId;
            messageContainer.innerHTML = quizHtml;
            chatMessages.appendChild(messageContainer);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            toolsPanel.style.display = 'none';
        }
        
        // „Ç´„Çπ„Çø„É†„ÇØ„Ç§„Ç∫Á¢∫Ë™ç
        function checkCustomQuiz(quizId, correctAnswer, userAnswer) {
            if (!userAnswer) return;
            
            const isCorrect = userAnswer.toLowerCase() === correctAnswer.toLowerCase();
            const resultMessage = isCorrect ? 'Ê≠£Ëß£ÔºÅüéâ' : '‰∏çÊ≠£Ëß£...üò¢';
            
            addMessage(resultMessage, '„ÇØ„Ç§„Ç∫ÁµêÊûú', true);
            
            if (isCorrect) {
                const quizContainer = document.querySelector(`[data-quiz-id="${quizId}"]`);
                if (quizContainer) {
                    const input = quizContainer.querySelector('.quiz-answer-input');
                    const button = quizContainer.querySelector('.game-button');
                    if (input) input.disabled = true;
                    if (button) button.disabled = true;
                }
            }
        };
        
        // ÁµµÊñáÂ≠ó‰ΩúÊàêÊ©üËÉΩ„ÅÆÂàùÊúüÂåñ
        function initEmojiCreator() {
            const textInput = document.getElementById('emojiText');
            const colorInput = document.getElementById('emojiColor');
            const bgColorInput = document.getElementById('emojiBgColor');
            const animationSelect = document.getElementById('emojiAnimation');
            const preview = document.getElementById('emojiPreview');
            
            function updatePreview() {
                const text = textInput.value || '?';
                const color = colorInput.value;
                const bgColor = bgColorInput.value;
                const animation = animationSelect.value;
                
                preview.textContent = text;
                preview.style.color = color;
                preview.style.backgroundColor = bgColor;
                preview.style.border = `2px solid ${color}`;
                
                // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇØ„É©„Çπ„Çí„É™„Çª„ÉÉ„Éà
                preview.className = 'custom-emoji-preview';
                if (animation !== 'none') {
                    preview.classList.add('animated-emoji', animation);
                }
            }
            
            textInput.addEventListener('input', updatePreview);
            colorInput.addEventListener('change', updatePreview);
            bgColorInput.addEventListener('change', updatePreview);
            animationSelect.addEventListener('change', updatePreview);
            
            updatePreview();
        }
        
        // Ëá™‰ΩúÁµµÊñáÂ≠ó„Çí‰ΩúÊàê
        function createUserEmoji() {
            const text = document.getElementById('emojiText').value.trim();
            const color = document.getElementById('emojiColor').value;
            const bgColor = document.getElementById('emojiBgColor').value;
            const animation = document.getElementById('emojiAnimation').value;
            
            if (!text) {
                alert('ÊñáÂ≠ó„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            const emoji = {
                id: Date.now(),
                text: text,
                color: color,
                bgColor: bgColor,
                animation: animation,
                name: `Ëá™‰Ωú${text}`
            };
            
            userEmojis.push(emoji);
            saveUserEmojis();
            updateUserEmojiGrid();
            
            // ÂÖ•Âäõ„Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('emojiText').value = '';
            document.getElementById('emojiColor').value = '#007bff';
            document.getElementById('emojiBgColor').value = '#ffffff';
            document.getElementById('emojiAnimation').value = 'none';
            
            // „Éó„É¨„Éì„É•„Éº„Çí„É™„Çª„ÉÉ„Éà
            const preview = document.getElementById('emojiPreview');
            preview.textContent = '?';
            preview.style.color = '';
            preview.style.backgroundColor = '';
            preview.style.border = '';
            preview.className = 'custom-emoji-preview';
        }
        
        // Ëá™‰ΩúÁµµÊñáÂ≠ó„Ç∞„É™„ÉÉ„Éâ„ÇíÊõ¥Êñ∞
        function updateUserEmojiGrid() {
            const grid = document.getElementById('userEmojiGrid');
            grid.innerHTML = '';
            
            userEmojis.forEach(emoji => {
                const item = document.createElement('div');
                item.className = 'user-emoji-item';
                item.style.color = emoji.color;
                item.style.backgroundColor = emoji.bgColor;
                item.style.border = `1px solid ${emoji.color}`;
                item.textContent = emoji.text;
                item.title = emoji.name;
                
                // ÂâäÈô§„Éú„Çø„É≥
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-user-emoji';
                deleteBtn.textContent = '√ó';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteUserEmoji(emoji.id);
                };
                item.appendChild(deleteBtn);
                
                // „ÇØ„É™„ÉÉ„ÇØ„ÅßÁµµÊñáÂ≠ó„Å®„Åó„Å¶ÈÄÅ‰ø°
                item.onclick = () => {
                    const emojiHtml = `<span style="color: ${emoji.color}; background-color: ${emoji.bgColor}; padding: 2px 4px; border-radius: 50%; border: 1px solid ${emoji.color};" class="${emoji.animation !== 'none' ? 'animated-emoji ' + emoji.animation : ''}">${emoji.text}</span>`;
                    addAnimatedMessage(emojiHtml, currentUsername, false);
                    emojiPanel.style.display = 'none';
                };
                
                grid.appendChild(item);
            });
        }
        
        // Ëá™‰ΩúÁµµÊñáÂ≠ó„ÇíÂâäÈô§
        function deleteUserEmoji(emojiId) {
            if (confirm('„Åì„ÅÆÁµµÊñáÂ≠ó„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                userEmojis = userEmojis.filter(emoji => emoji.id !== emojiId);
                saveUserEmojis();
                updateUserEmojiGrid();
            }
        }
    </script>
</body>
</html>
